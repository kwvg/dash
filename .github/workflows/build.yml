name: CI

on:
  push:
  pull_request_target:

permissions:
  contents: read
  packages: write

env:
  DOCKER_DRIVER: overlay2
  FAST_MODE: false

jobs:
  container:
    name: Build container
    uses: ./.github/workflows/build-container.yml

  depends-linux64_nowallet:
    name: x86_64-pc-linux-gnu_nowallet
    uses: ./.github/workflows/build-depends.yml
    needs: [container]
    with:
      build-target: linux64_nowallet
      container-path: ${{ needs.container.outputs.path }}

  src-linux64_nowallet:
    name: linux64_nowallet-build
    uses: ./.github/workflows/build-src.yml
    needs: [container, depends-linux64_nowallet]
    with:
      build-target: linux64_nowallet
      container-path: ${{ needs.container.outputs.path }}
      depends-key: ${{ needs.depends-linux64_nowallet.outputs.key }}

  test-linux64_nowallet:
    name: linux64_nowallet-test
    uses: ./.github/workflows/test-src.yml
    needs: [container, depends-linux64_nowallet, src-linux64_nowallet]
    with:
      bundle-key: ${{ needs.src-linux64_nowallet.outputs.key }}
      build-target: linux64_nowallet
      container-path: ${{ needs.container.outputs.path }}
